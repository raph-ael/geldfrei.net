(function(g){function v(){}g.fn.textext.TextExtTags=v;g.fn.textext.addPlugin("tags",v);var o=v.prototype,i=".",n="text-tags-on-top",k=i+n,q="text-tag",s=i+q,e="text-tags",a=i+e,j="text-label",m=i+j,d="text-remove",f=i+d,l="tags.enabled",h="tags.items",t="html.tag",u="html.tags",b="isTagAllowed",r="tagClick",c={tags:{enabled:true,items:null},html:{tags:'<div class="text-tags"/>',tag:'<div class="text-tag"><div class="text-button"><span class="text-label"/><a class="text-remove"/></div></div>'}};o.init=function(w){this.baseInit(w,c);var y=this,x=y.input(),p;if(y.opts(l)){p=g(y.opts(u));x.after(p);g(y).data("container",p);y.on({enterKeyPress:y.onEnterKeyPress,backspaceKeyDown:y.onBackspaceKeyDown,preInvalidate:y.onPreInvalidate,postInit:y.onPostInit,getFormData:y.onGetFormData});y.on(p,{click:y.onClick,mousemove:y.onContainerMouseMove});y.on(x,{mousemove:y.onInputMouseMove})}y._originalPadding={left:parseInt(x.css("paddingLeft")||0),top:parseInt(x.css("paddingTop")||0)};y._paddingBox={left:0,top:0};y.updateFormCache()};o.containerElement=function(){return g(this).data("container")};o.onPostInit=function(w){var p=this;p.addTags(p.opts(h))};o.onGetFormData=function(A,y,z){var w=this,p=z===13?"":w.val(),x=w._formData;y[200]=w.formDataObject(p,x)};o.initPriority=function(){return 100};o.onInputMouseMove=function(p){this.toggleZIndex(p)};o.onContainerMouseMove=function(p){this.toggleZIndex(p)};o.onBackspaceKeyDown=function(x){var p=this,w=p.tagElements().last();if(p.val().length==0){p.removeTag(w)}};o.onPreInvalidate=function(x){var p=this,w=p.tagElements().last(),y=w.position();if(w.length>0){y.left+=w.innerWidth()}else{y=p._originalPadding}p._paddingBox=y;p.input().css({paddingLeft:y.left,paddingTop:y.top})};o.onClick=function(B){var y=this,x=y.core(),A=g(B.target),w=0,p;if(A.is(a)){w=1}else{if(A.is(f)){y.removeTag(A.parents(s+":first"));w=1}else{if(A.is(m)){p=A.parents(s+":first");y.trigger(r,p,p.data(q),z)}}}function z(D,C){p.data(q,D);p.find(m).text(y.itemManager().itemToString(D));y.updateFormCache();x.getFormData();x.invalidateBounds();if(C){x.focusInput()}}if(w){x.focusInput()}};o.onEnterKeyPress=function(x){var w=this,y=w.val(),p=w.itemManager().stringToItem(y);if(w.isTagAllowed(p)){w.addTags([p]);w.core().focusInput()}};o.updateFormCache=function(){var w=this,p=[];w.tagElements().each(function(){p.push(g(this).data(q))});w._formData=p};o.toggleZIndex=function(C){var D=this,A=D.input().offset(),y=C.clientX-A.left,x=C.clientY-A.top,B=D._paddingBox,p=D.containerElement(),z=p.is(k),w=y>B.left&&x>B.top;if(!z&&!w||z&&w){p[(!z?"add":"remove")+"Class"](n)}};o.tagElements=function(){return this.containerElement().find(s)};o.isTagAllowed=function(p){var w={tag:p,result:true};this.trigger(b,w);return w.result===true};o.addTags=function(z){if(!z||z.length==0){return}var y=this,x=y.core(),w=y.containerElement(),A,p;for(A=0;A<z.length;A++){p=z[A];if(p&&y.isTagAllowed(p)){w.append(y.renderTag(p))}}y.updateFormCache();x.getFormData();x.invalidateBounds()};o.getTagElement=function(p){var w=this,z=w.tagElements(),x,y;for(x=0;x<z.length;x++){y=g(z[x]);if(w.itemManager().compareItems(y.data(q),p)){return y}}return null};o.removeTag=function(p){var x=this,w=x.core(),y;if(p instanceof g){y=p;p=p.data(q)}else{y=x.getTagElement(p);if(y===null){return}}y.remove();x.updateFormCache();w.getFormData();w.invalidateBounds()};o.renderTag=function(p){var w=this,x=g(w.opts(t));x.find(".text-label").text(w.itemManager().itemToString(p));x.data(q,p);return x}})(jQuery);