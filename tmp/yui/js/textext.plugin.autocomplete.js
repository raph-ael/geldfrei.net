(function(d){function h(){}d.fn.textext.TextExtAutocomplete=h;d.fn.textext.addPlugin("autocomplete",h);var q=h.prototype,f=".",t="text-selected",c=f+t,i="text-suggestion",k=f+i,g="text-label",n=f+g,m="autocomplete.enabled",z="autocomplete.dropdown.position",y="autocomplete.dropdown.maxHeight",b="autocomplete.render",v="html.dropdown",l="html.suggestion",s="hideDropdown",w="showDropdown",o="getSuggestions",j="getFormData",u="toggleDropdown",e="above",x="below",r="mousedownOnAutocomplete",a={autocomplete:{enabled:true,dropdown:{position:x,maxHeight:"100px"}},html:{dropdown:'<div class="text-dropdown"><div class="text-list"/></div>',suggestion:'<div class="text-suggestion"><span class="text-label"/></div>'}};q.init=function(A){var C=this;C.baseInit(A,a);var B=C.input(),p;if(C.opts(m)===true){C.on({blur:C.onBlur,anyKeyUp:C.onAnyKeyUp,deleteKeyUp:C.onAnyKeyUp,backspaceKeyPress:C.onBackspaceKeyPress,enterKeyPress:C.onEnterKeyPress,escapeKeyPress:C.onEscapeKeyPress,setSuggestions:C.onSetSuggestions,showDropdown:C.onShowDropdown,hideDropdown:C.onHideDropdown,toggleDropdown:C.onToggleDropdown,postInvalidate:C.positionDropdown,getFormData:C.onGetFormData,downKeyDown:C.onDownKeyDown,upKeyDown:C.onUpKeyDown});p=d(C.opts(v));p.insertAfter(B);C.on(p,{mouseover:C.onMouseOver,mousedown:C.onMouseDown,click:C.onClick});p.css("maxHeight",C.opts(y)).addClass("text-position-"+C.opts(z));d(C).data("container",p);d(document.body).click(function(D){if(C.isDropdownVisible()&&!C.withinWrapElement(D.target)){C.trigger(s)}});C.positionDropdown()}};q.containerElement=function(){return d(this).data("container")};q.onMouseOver=function(B){var p=this,A=d(B.target);if(A.is(k)){p.clearSelected();A.addClass(t)}};q.onMouseDown=function(p){this.containerElement().data(r,true)};q.onClick=function(B){var p=this,A=d(B.target);if(A.is(k)||A.is(n)){p.trigger("enterKeyPress")}if(p.core().hasPlugin("tags")){p.val("")}};q.onBlur=function(C){var B=this,p=B.containerElement(),A=p.data(r)===true;if(B.isDropdownVisible()){A?B.core().focusInput():B.trigger(s)}p.removeData(r)};q.onBackspaceKeyPress=function(A){var p=this,B=p.val().length>0;if(B||p.isDropdownVisible()){p.getSuggestions()}};q.onAnyKeyUp=function(B,A){var p=this,C=p.opts("keys."+A)!=null;if(p.val().length>0&&!C){p.getSuggestions()}};q.onDownKeyDown=function(A){var p=this;p.isDropdownVisible()?p.toggleNextSuggestion():p.getSuggestions()};q.onUpKeyDown=function(p){this.togglePreviousSuggestion()};q.onEnterKeyPress=function(A){var p=this;if(p.isDropdownVisible()){p.selectFromDropdown()}};q.onEscapeKeyPress=function(A){var p=this;if(p.isDropdownVisible()){p.trigger(s)}};q.positionDropdown=function(){var B=this,A=B.containerElement(),D=B.opts(z),p=B.core().wrapElement().outerHeight(),C={};C[D===e?"bottom":"top"]=p+"px";A.css(C)};q.suggestionElements=function(){return this.containerElement().find(k)};q.setSelectedSuggestion=function(A){if(!A){return}var p=this,C=p.suggestionElements(),E=C.first(),D,B;p.clearSelected();for(B=0;B<C.length;B++){D=d(C[B]);if(p.itemManager().compareItems(D.data(i),A)){E=D.addClass(t);break}}E.addClass(t);p.scrollSuggestionIntoView(E)};q.selectedSuggestionElement=function(){return this.suggestionElements().filter(c).first()};q.isDropdownVisible=function(){return this.containerElement().is(":visible")===true};q.onGetFormData=function(E,C,D){var A=this,F=A.val(),p=F,B=F;C[100]=A.formDataObject(p,B)};q.initPriority=function(){return 200};q.onHideDropdown=function(p){this.hideDropdown()};q.onToggleDropdown=function(A){var p=this;p.trigger(p.containerElement().is(":visible")?s:w)};q.onShowDropdown=function(C,D){var A=this,B=A.selectedSuggestionElement().data(i),p=A._suggestions;if(!p){return A.trigger(o)}if(d.isFunction(D)){D(A)}else{A.renderSuggestions(A._suggestions);A.toggleNextSuggestion()}A.showDropdown(A.containerElement());A.setSelectedSuggestion(B)};q.onSetSuggestions=function(C,B){var A=this,p=A._suggestions=B.result;if(B.showHideDropdown!==false){A.trigger(p===null||p.length===0?s:w)}};q.getSuggestions=function(){var p=this,A=p.val();if(p._previousInputValue==A){return}if(A==""){current=null}p._previousInputValue=A;p.trigger(o,{query:A})};q.clearItems=function(){this.containerElement().find(".text-list").children().remove()};q.renderSuggestions=function(p){var A=this;A.clearItems();d.each(p||[],function(B,C){A.addSuggestion(C)})};q.showDropdown=function(){this.containerElement().show()};q.hideDropdown=function(){var p=this,A=p.containerElement();p._previousInputValue=null;A.hide()};q.addSuggestion=function(A){var p=this,C=p.opts(b),B=p.addDropdownItem(C?C.call(p,A):p.itemManager().itemToString(A));B.data(i,A)};q.addDropdownItem=function(B){var A=this,p=A.containerElement().find(".text-list"),C=d(A.opts(l));C.find(".text-label").html(B);p.append(C);return C};q.clearSelected=function(){this.suggestionElements().removeClass(t)};q.toggleNextSuggestion=function(){var p=this,B=p.selectedSuggestionElement(),A;if(B.length>0){A=B.next();if(A.length>0){B.removeClass(t)}}else{A=p.suggestionElements().first()}A.addClass(t);p.scrollSuggestionIntoView(A)};q.togglePreviousSuggestion=function(){var p=this,A=p.selectedSuggestionElement(),B=A.prev();if(B.length==0){return}p.clearSelected();B.addClass(t);p.scrollSuggestionIntoView(B)};q.scrollSuggestionIntoView=function(D){var G=D.outerHeight(),F=this.containerElement(),B=F.innerHeight(),E=F.scrollTop(),A=(D.position()||{}).top,p=null,C=parseInt(F.css("paddingTop"));if(A==null){return}if(A+G>B){p=A+E+G-B+C}if(A<0){p=A+E-C}if(p!=null){F.scrollTop(p)}};q.selectFromDropdown=function(){var A=this,p=A.selectedSuggestionElement().data(i);if(p){A.val(A.itemManager().itemToString(p));A.core().getFormData()}A.trigger(s)};q.withinWrapElement=function(p){return this.core().wrapElement().find(p).size()>0}})(jQuery);